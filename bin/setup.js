const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");

const repo_root = path.resolve(__dirname, "..");
const plugin_env_path = path.join(repo_root, "plugin-env");

const package_json_path = path.join(plugin_env_path, "package.json");
const readme_path = path.join(plugin_env_path, "README.txt");

const builtin_package = "https://github.com/Pi-Tray/builtin-plugins.git";

const readme_content = `plugin-env
=============

This is the directory where Pi-Tray loads its plugins from. It is generated by the setup script and is
the place where users can add their own plugins without having to worry about committing them to the repository.

You should ensure you install plugins in this directory, not the root of the repository.

Ideally, we wouldn't have to do this, but installing npm modules with --no-save would lose the module when you
next run npm install.
`;

try {
    if (!fs.existsSync(plugin_env_path)) {
        fs.mkdirSync(plugin_env_path);
        console.log("Created plugin-env directory");
    }

    // write dummy package.json to tell npm this is a subpackage
    fs.writeFileSync(package_json_path, "{}", "utf8");
    console.log("Wrote package.json to plugin-env");

    // install builtin plugins
    execSync(`npm install ${builtin_package}`, { cwd: plugin_env_path, stdio: "inherit" });
    console.log("Installed builtin plugins");

    // write readme
    fs.writeFileSync(readme_path, readme_content, "utf8");
    console.log("Wrote README.txt to plugin-env");

    console.log("Setup complete");
} catch (err) {
    console.error("Error during setup:", err);
    process.exit(1);
}
